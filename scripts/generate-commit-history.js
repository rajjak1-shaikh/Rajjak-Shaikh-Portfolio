const fs = require('fs');
const { execSync } = require('child_process');
const path = require('path');

// Configuration
const START_DATE = new Date('2025-08-01'); // Start from roughly 6 months ago
const END_DATE = new Date(); // Today
const TARGET_FILE = path.join(__dirname, '..', 'ACTIVITY_LOG.md');

// Realistic commit messages organized by type
const COMMIT_TYPES = [
    {
        type: 'feat', weight: 0.3, messages: [
            'update user profile layout',
            'add dark mode toggle',
            'implement search functionality',
            'add loading skeletons for dashboard',
            'integrate newsletter subscription form',
            'create reusable button component',
            'setup basic routing structure',
            'add support for image optimization',
            'implement secure authentication flow',
            'add analytics tracking',
            'create animated hero section',
            'add form validation logic',
            'implement pagination for blog posts',
            'add social media sharing links',
            'create responsive navigation bar'
        ]
    },
    {
        type: 'fix', weight: 0.25, messages: [
            'resolve hydration mismatch error',
            'fix broken link in footer',
            'correct margin on mobile devices',
            'fix typo in landing page copy',
            'resolve race condition in data fetching',
            'fix z-index issue on modal',
            'correct color contrast for accessibility',
            'handle null state in user card',
            'fix memory leak in event listener',
            'resolve issue with font loading',
            'fix infinite loop in useEffect',
            'correct date formatting',
            'fix overflow issue on small screens',
            'resolve api timeout error'
        ]
    },
    {
        type: 'refactor', weight: 0.2, messages: [
            'clean up unused imports',
            'simplify state management logic',
            'extract helper functions to utils',
            'rename components for clarity',
            'optimize image loading strategy',
            'restructure folder hierarchy',
            'remove deprecated api calls',
            'improve code readability',
            'modernize css usage',
            'optimize loop performance',
            'unify color palette variables',
            'update dependency versions'
        ]
    },
    {
        type: 'docs', weight: 0.1, messages: [
            'update README with setup instructions',
            'add comments to complex logic',
            'document api endpoints',
            'update contribution guidelines',
            'add structure diagram',
            'fix typos in documentation',
            'update license file',
            'add changelog entry',
            'document environment variables'
        ]
    },
    {
        type: 'chore', weight: 0.1, messages: [
            'update npm dependencies',
            'configure eslint rules',
            'update .gitignore',
            'tweak prettier config',
            'cleanup console logs',
            'update vercel configuration',
            'organize assets folder',
            'update test command scripts',
            'modify typescript config',
            'cleanup temporary files'
        ]
    },
    {
        type: 'test', weight: 0.05, messages: [
            'add unit tests for utility functions',
            'setup jest configuration',
            'add integration test for login flow',
            'update snapshot tests',
            'add end-to-end test cases',
            'mock api response for testing',
            'fix flaky test'
        ]
    }
];

// Helper to pick a random item based on weights
function weightedRandom(items) {
    const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
    let random = Math.random() * totalWeight;

    for (const item of items) {
        random -= item.weight;
        if (random <= 0) {
            return item;
        }
    }
    return items[0]; // Fallback
}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function formatDateForGit(date) {
    return date.toISOString();
}

// Run
function generateHistory() {
    const TODAY = new Date();
    console.log(`Generating 30 commits for ${TODAY.toDateString()}...`);

    const TARGET_COMMITS = 30; // Exactly 30 commits today
    let totalCommits = 0;

    // Clear the log file content first to start fresh
    // fs.writeFileSync(TARGET_FILE, '# Activity Log\n\nThis file tracks the contribution history generated by the automated script.\n');

    for (let i = 0; i < TARGET_COMMITS; i++) {
        const commitTime = new Date(TODAY);
        // Distribute randomly between 9 AM and 11 PM
        commitTime.setHours(getRandomInt(9, 23));
        commitTime.setMinutes(getRandomInt(0, 59));
        commitTime.setSeconds(getRandomInt(0, 59));

        // If running late at night, ensure we don't go to future if strictly enforcing, 
        // but since we want "today", we just use the current date. 
        // If "today" means "now", we might want to be careful, but "today" usually covers the whole calendar day.
        // Let's cap it at the current time if we want to be super precise, or just allow the whole day.
        // Given it's a "backfill" style script, usually we can do earlier in the day.

        const category = weightedRandom(COMMIT_TYPES);
        const messageBody = category.messages[Math.floor(Math.random() * category.messages.length)];
        const commitMessage = `${category.type}: ${messageBody}`;

        try {
            fs.appendFileSync(TARGET_FILE, `\n- [${commitTime.toISOString()}] ${commitMessage}`);

            const dateStr = commitTime.toISOString();
            execSync(`git add "${TARGET_FILE}"`);
            execSync(`git commit -m "${commitMessage}"`, {
                env: {
                    ...process.env,
                    GIT_AUTHOR_DATE: dateStr,
                    GIT_COMMITTER_DATE: dateStr
                }
            });

            totalCommits++;
            console.log(`[${i + 1}/${TARGET_COMMITS}] [${dateStr}] ${commitMessage}`);
        } catch (error) {
            console.error(`Failed to commit:`, error.message);
        }
    }

    console.log(`\nSuccessfully generated ${totalCommits} commits for today!`);
}

// Run
try {
    generateHistory();
} catch (error) {
    console.error('Fatal error:', error);
}
